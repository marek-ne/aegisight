<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Risk Dashboard - Aegisight AI</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-dark: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --card-border: rgba(148, 163, 184, 0.1);
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent-primary: #6366f1;
            --success: #4ade80;
            --warning: #fbbf24;
            --danger: #f87171;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            margin: 0;
            min-height: 100vh;
        }

        .dashboard-container {
            padding: 24px;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Navbar */
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--card-border);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .nav-links a {
            color: var(--text-secondary);
            text-decoration: none;
            margin-left: 24px;
            font-size: 0.9rem;
            transition: color 0.2s;
        }

        .nav-links a:hover {
            color: var(--text-primary);
        }

        /* Header */
        .dashboard-header {
            margin: 32px 0;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .header-title h1 {
            font-size: 1.8rem;
            margin: 0 0 8px 0;
            background: linear-gradient(to right, #fff, #a5b4fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-meta {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Grid Layouts */
        .grid-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }

        .grid-main {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .grid-bottom {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 24px;
            backdrop-filter: blur(12px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Metrics */
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            margin-top: 8px;
        }

        .metric-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        /* Gauge */
        .gauge-wrapper {
            position: relative;
            width: 200px;
            height: 100px;
            margin: 0 auto;
            overflow: hidden;
        }

        .gauge-bg {
            width: 200px;
            height: 100px;
            background: #334155;
            border-radius: 100px 100px 0 0;
        }

        .gauge-fill {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--success);
            transform-origin: center top;
            transform: rotate(0deg);
            border-radius: 100px 100px 0 0;
            transition: transform 1s ease-out, background 0.3s;
        }

        .gauge-cover {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 160px;
            height: 80px;
            background: var(--bg-dark);
            /* Should match card bg or slightly darker */
            background: #151d30;
            /* Manual tweak to match card blur visual approx */
            border-radius: 80px 80px 0 0;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 10px;
        }

        .score-big {
            font-size: 2.5rem;
            font-weight: 700;
            color: #fff;
            position: relative;
            z-index: 10;
            text-align: center;
            margin-top: -40px;
        }

        .risk-factors {
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid var(--card-border);
        }

        .factor-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            margin-bottom: 6px;
        }

        .progress-bg {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .progress-bar {
            height: 100%;
            background: var(--accent-primary);
            width: 0%;
            transition: width 1s ease;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th {
            text-align: left;
            padding: 12px;
            color: var(--text-secondary);
            font-weight: 500;
            border-bottom: 1px solid var(--card-border);
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--card-border);
            color: var(--text-primary);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-Operational {
            background: rgba(74, 222, 128, 0.1);
            color: var(--success);
        }

        .status-Degraded {
            background: rgba(251, 191, 36, 0.1);
            color: var(--warning);
        }

        .status-Maintenance {
            background: rgba(148, 163, 184, 0.1);
            color: var(--text-secondary);
        }

        .status-Critical {
            background: rgba(248, 113, 113, 0.1);
            color: var(--danger);
        }

        /* Alerts */
        .alert-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .alert-item {
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            border-left: 3px solid var(--text-secondary);
        }

        .alert-critical {
            border-left-color: var(--danger);
            background: rgba(248, 113, 113, 0.05);
        }

        .alert-warning {
            border-left-color: var(--warning);
        }

        .alert-info {
            border-left-color: var(--accent-primary);
        }

        .alert-msg {
            font-size: 0.9rem;
            margin-bottom: 4px;
        }

        .alert-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Responsive */
        @media (max-width: 1024px) {

            .grid-main,
            .grid-bottom {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body class="dark-theme">
    <nav class="navbar">
        <div class="logo">
            <a href="/"><img src="/aegisight-logo.png" alt="Aegisight AI" height="32"></a>
        </div>
        <div class="nav-links">
            <span id="userGreeting" style="margin-right: 20px; color: #a5b4fc;"></span>
            <a href="/risk-audit">Risk Audit</a>
            <a href="/settings">Settings</a>
            <a href="/account">Profile</a>
        </div>
    </nav>

    <div class="dashboard-container">
        <!-- Header -->
        <div class="dashboard-header">
            <div class="header-title">
                <h1>Executive Risk Overview</h1>
                <div class="header-meta">Real-time AI monitoring across IT infrastructure</div>
            </div>
            <div>
                <button onclick="syncNow()" id="syncBtn"
                    style="background: var(--accent-primary); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                    Sync ServiceNow
                </button>
            </div>
        </div>

        <!-- Metrics Row -->
        <div class="grid-metrics">
            <div class="card">
                <div class="metric-label">Active Incidents</div>
                <div class="metric-value" id="mIncidents">--</div>
            </div>
            <div class="card">
                <div class="metric-label">MTTR (Avg)</div>
                <div class="metric-value" id="mMttr">--</div>
            </div>
            <div class="card">
                <div class="metric-label">Model Accuracy</div>
                <div class="metric-value" id="mAccuracy" style="color: var(--success);">--</div>
            </div>
            <div class="card">
                <div class="metric-label">System Health</div>
                <div class="metric-value" id="mHealth">--</div>
            </div>
        </div>

        <!-- Main Chart & Gauge Row -->
        <div class="grid-main">
            <!-- Chart Area -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Incident Velocity vs Anomaly Threshold</div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">Last 24 Hours</div>
                </div>
                <div style="height: 300px;">
                    <canvas id="riskChart"></canvas>
                </div>
            </div>

            <!-- Gauge / Risk Panel -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Real-Time Risk Score</div>
                    <div class="status-badge" id="riskBadge">ANALYZING</div>
                </div>

                <div class="gauge-wrapper">
                    <div class="gauge-bg"></div>
                    <div class="gauge-fill" id="gaugeFill"></div>
                    <div class="gauge-cover"></div>
                </div>
                <div class="score-big" id="scoreValue">--%</div>

                <div class="risk-factors">
                    <div class="card-title" style="font-size: 0.9rem; margin-bottom: 12px;">Hybrid Model
                        Contributors
                    </div>

                    <div class="factor-row">
                        <span>XGBoost (Pattern)</span>
                        <span id="xgbValue">--%</span>
                    </div>
                    <div class="progress-bg">
                        <div class="progress-bar" id="xgbBar"></div>
                    </div>

                    <div class="factor-row">
                        <span>ARIMA (Anomaly)</span>
                        <span id="arimaValue">--%</span>
                    </div>
                    <div class="progress-bg">
                        <div class="progress-bar" id="arimaBar"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Row: Service Status & Alerts -->
        <div class="grid-bottom">
            <!-- Service Health Table -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Service Functionality Status</div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Service Name</th>
                                <th>Status</th>
                                <th>Uptime (30d)</th>
                                <th>Last Check</th>
                            </tr>
                        </thead>
                        <tbody id="serviceTableBody">
                            <!-- Populated by JS -->
                            <tr>
                                <td colspan="4" style="text-align:center; color: var(--text-secondary);">Loading...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Alerts Feed -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Recent Alerts</div>
                    <a href="#" style="font-size: 0.8rem; color: var(--accent-primary); text-decoration: none;">View
                        All</a>
                </div>
                <div class="alert-list" id="alertList">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Store chart instance to destroy/update
        let riskChartInstance = null;

        async function fetchDashboardData() {
            try {
                const res = await fetch('/api/risk/status');
                const data = await res.json();

                renderMetrics(data.metrics);
                renderGauge(data.currentRiskScore, data.status);
                renderRiskFactors(data.evidence.details);
                renderChart(data.evidence);
                renderServiceHealth(data.serviceHealth);
                renderAlerts(data.alerts);

                // Update system health metric roughly based on risk
                document.getElementById('mHealth').textContent = data.status === 'CRITICAL' ? 'At Risk' : 'Healthy';
                document.getElementById('mHealth').style.color = data.status === 'CRITICAL' ? 'var(--danger)' : 'var(--success)';

            } catch (err) {
                console.error('Dashboard fetch error:', err);
            }
        }

        // 1. Render Metrics
        function renderMetrics(metrics) {
            if (!metrics) return;
            document.getElementById('mIncidents').textContent = metrics.activeIncidents ?? 0;
            document.getElementById('mMttr').textContent = metrics.mttr ?? '--';
            document.getElementById('mAccuracy').textContent = metrics.predictionAccuracy ?? '--';
        }

        // 2. Render Gauge
        function renderGauge(score, status) {
            const pct = Math.round(score * 100);
            document.getElementById('scoreValue').textContent = pct + '%';

            // Rotate 0.0 -> 0deg, 1.0 -> 180deg
            const deg = score * 180;
            const fill = document.getElementById('gaugeFill');
            fill.style.transform = `rotate(${deg}deg)`;

            // Color logic
            const isCritical = status === 'CRITICAL';
            fill.style.background = isCritical ? 'var(--danger)' : 'var(--success)';

            const badge = document.getElementById('riskBadge');
            badge.textContent = status;
            badge.className = `status-badge status-${status === 'CRITICAL' ? 'Critical' : 'Operational'}`;
        }

        // 3. Render Factors
        function renderRiskFactors(details) {
            if (!details) return;

            const xgb = Math.round((details.xgb_score || 0) * 100);
            document.getElementById('xgbValue').textContent = xgb + '%';
            document.getElementById('xgbBar').style.width = xgb + '%';
            document.getElementById('xgbBar').style.background = xgb > 75 ? 'var(--danger)' : 'var(--accent-primary)';

            const arima = Math.round((details.arima_score || 0) * 100);
            document.getElementById('arimaValue').textContent = arima + '%';
            document.getElementById('arimaBar').style.width = arima + '%';
            document.getElementById('arimaBar').style.background = arima > 75 ? 'var(--danger)' : '#f472b6';
        }

        // 4. Render Chart
        function renderChart(evidence) {
            const ctx = document.getElementById('riskChart').getContext('2d');

            // Mock History Generation (since API sends single point for MVP)
            const labels = [];
            const dataPts = [];
            const threshold = [];
            const now = new Date();

            for (let i = 10; i >= 0; i--) {
                const t = new Date(now.getTime() - i * 15 * 60000); // 15 min intervals
                labels.push(t.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));

                // Add some randomness but end on actual value
                if (i === 0) {
                    dataPts.push(evidence.value);
                } else {
                    const noise = (Math.random() - 0.5) * 10;
                    dataPts.push(Math.max(0, evidence.value + noise - (i * 2))); // Trend up or down
                }
                threshold.push(evidence.threshold);
            }

            if (riskChartInstance) riskChartInstance.destroy();

            riskChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Ticket Velocity',
                            data: dataPts,
                            borderColor: '#818cf8',
                            backgroundColor: 'rgba(129, 140, 248, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 3
                        },
                        {
                            label: 'Anomaly Threshold',
                            data: threshold,
                            borderColor: '#f87171',
                            borderDash: [5, 5],
                            pointRadius: 0,
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { color: '#94a3b8' } }
                    },
                    scales: {
                        y: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#94a3b8' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#94a3b8' }
                        }
                    }
                }
            });
        }

        // 5. Render Service Health
        function renderServiceHealth(services) {
            const tbody = document.getElementById('serviceTableBody');
            if (!services || services.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center">No service data</td></tr>';
                return;
            }

            tbody.innerHTML = services.map(svc => `
                <tr>
                    <td>
                        <div style="font-weight: 500;">${svc.name}</div>
                    </td>
                    <td>
                        <span class="status-badge status-${svc.status.replace(' ', '')}">${svc.status}</span>
                    </td>
                    <td style="font-family: monospace;">${svc.uptime || '--'}</td>
                    <td style="color: var(--text-secondary); font-size: 0.8rem;">Now</td>
                </tr>
            `).join('');
        }

        // 6. Render Alerts
        function renderAlerts(alerts) {
            const list = document.getElementById('alertList');
            if (!alerts || alerts.length === 0) {
                list.innerHTML = '<div style="color: var(--text-secondary); text-align: center;">No active alerts</div>';
                return;
            }

            list.innerHTML = alerts.map(alert => `
                <div class="alert-item alert-${alert.type}">
                    <div class="alert-msg"><strong>${alert.type.toUpperCase()}:</strong> ${alert.message}</div>
                    <div class="alert-time">${alert.time}</div>
                </div>
            `).join('');
        }

        async function syncNow() {
            const btn = document.getElementById('syncBtn');
            const orig = btn.textContent;
            btn.textContent = 'Syncing...';
            btn.disabled = true;

            // Mock sync delay
            await new Promise(r => setTimeout(r, 1500));

            // Re-fetch
            await fetchDashboardData();

            btn.textContent = 'Sync Complete';
            setTimeout(() => {
                btn.textContent = orig;
                btn.disabled = false;
            }, 2000);
        }

        // Initialize
        fetchDashboardData();
        // Poll every 30s
        setInterval(fetchDashboardData, 30000);

    </script>
</body>

</html>